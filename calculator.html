<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>넘기기 작업 계산기 (시인성 개선)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
/* -------------------- 전역 스타일 -------------------- */
html, body {
    margin:0; padding:0; height:100%;
    font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background:#1a1a2e; color:#fff;
    overflow: hidden;
}
h1{
    text-align:center; margin:0; padding:16px; font-size:30px;
    color:#f0f0f0; position: relative; z-index: 2; background:#1a1a2e;
}
.content-wrapper {
    position: absolute; top:62px; left:0; right:0; bottom:0;
    overflow-y:auto; overflow-x:hidden; padding-bottom:20px;
    z-index:1; display:flex; flex-direction:column; align-items:center;
}

/* -------------------- 메인 레이아웃: 3분할 -------------------- */
.top-area {
    width:95%; max-width:1050px; display:flex;
    justify-content:space-between; gap:15px; margin:20px auto 10px auto;
    align-items: stretch;
}
.info-panel, .prod-panel, .record-panel {
    background:#252540; padding:15px; border-radius:14px;
    box-shadow:0 4px 15px rgba(0,0,0,0.3); box-sizing: border-box;
    display: flex; flex-direction: column;
}
.info-panel{flex:1; min-width:250px;}
.prod-panel{flex:1.5; min-width:300px;}
.record-panel{flex:1; min-width:250px;}

@media (max-width:900px){
    .top-area{flex-wrap: wrap; align-items: flex-start;}
    .info-panel, .prod-panel, .record-panel {height: auto;}
    .record-panel{order: 3; width: 100%; max-width: 900px; margin-top: 15px;}
    .info-panel, .prod-panel{flex: 1 1 45%;}
}
@media (max-width:600px){
    .top-area{flex-direction:column; gap:15px;}
    .info-panel, .prod-panel, .record-panel{width: 100%;}
    .record-panel{margin-top: 0;}
}

/* -------------------- 입력 및 버튼 -------------------- */
label {
    display: block; margin-top: 10px; font-size: 16px;
    font-weight: 600; color: #ccc; word-break: break-word; line-height: 1.3;
}
input{
    width:100%; padding:10px 14px; font-size:19px; border-radius:8px;
    border:1px solid #3e3e60; margin-top:6px; background:#333355;
    color:#fff; box-sizing:border-box; cursor:pointer;
}
.buttons{margin-top:auto; padding-top:15px; display:flex; justify-content:space-between; flex-wrap:wrap; gap: 8px;}
.buttons button{
    flex:1; margin:0; padding:10px 0; font-size:16px; border-radius:10px;
    border:none; background:#3a79d8; color:#fff; font-weight:700;
    transition:background 0.2s; user-select:none;
}
.buttons button.btn-primary {background: #2ecc71;}
.buttons button:active{filter: brightness(0.9);}

.prod-list, .record-list {
    flex-grow: 1; margin-top:10px; max-height: 40vh;
    overflow-y:auto; padding-right:10px;
}
.prod-row{display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;}
.prod-row div{font-size:15px; font-weight:600; min-width:70px; margin-bottom:0;}
.prod-row input{width:calc(100% - 80px) !important; padding:8px 12px;}

.record-item{
    display:flex; justify-content:space-between; align-items:center;
    padding:8px 10px; border-bottom: 1px solid #3e3e60;
    cursor:pointer; transition: background 0.1s;
}
.record-details{flex:1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
.record-item:hover{background: #333355;}
.record-delete{
    background:none; border:none; color:#e74c3c; font-size:18px;
    font-weight:bold; cursor:pointer; padding:5px 8px; margin-left:10px;
    flex-shrink: 0; line-height: 1; font-family: Arial, sans-serif;
}
.record-date{font-size:13px; color:#b0b0d0;}
.record-summary{font-size:15px; font-weight:700;}

/* -------------------- 미리보기 -------------------- */
.cuts{width:90%; max-width:700px; margin:0 auto 20px auto; text-align:center;}
.cuts h3{margin-bottom:10px; color:#3498db; font-size:20px;}
.preview-cuts-list{max-height: 35vh; overflow-y: auto; padding-right: 10px;}
.cut-row{
    display:flex; justify-content:space-between; align-items:center;
    padding:12px 15px; border-radius:12px; background:#252540;
    margin-bottom:6px; box-shadow:0 2px 8px rgba(0,0,0,0.2);
}
.cut-left{display:flex; flex-direction:column; text-align:left;}
.cut-row .prod-name{font-size:18px; font-weight:700; color:#3498db;}
.cut-row .prod-len{font-size:11px; color:#b0b0d0;}
.cut-row .cut-pos{font-size:30px; font-weight:900; color:#e74c3c;}

/* -------------------- 키패드 (개선) -------------------- */
#softKeypad{
    position: fixed; bottom: 0; left: 0; right: 0;
    width: 100%; max-width: none;
    background: #1c1c34; padding: 10px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
    border-radius: 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
    z-index: 10002; margin: 0; box-sizing: border-box;
}
.keypad-button{
    padding:18px; font-size:26px; font-weight:bold; background:#4a4a75;
    color:#fff; border:none; border-radius:8px; user-select:none;
    cursor:pointer; transition:background 0.1s; touch-action:manipulation;
}
.keypad-button:active{background:#3a3a60;}
.keypad-action{background:#e74c3c !important; font-size: 20px !important;}
.keypad-action:active{background:#c0392b !important;}
#enterKey{background:#3498db !important; font-size: 20px !important; grid-row: 3 / span 2; grid-column: 4;}
#enterKey:active{background:#2980b9 !important;}
.keypad-button[data-key="7"] { grid-row: 1; grid-column: 1; }
.keypad-button[data-key="8"] { grid-row: 1; grid-column: 2; }
.keypad-button[data-key="9"] { grid-row: 1; grid-column: 3; }
.keypad-button[data-key="back"] { grid-row: 1; grid-column: 4; }
.keypad-button[data-key="4"] { grid-row: 2; grid-column: 1; }
.keypad-button[data-key="5"] { grid-row: 2; grid-column: 2; }
.keypad-button[data-key="6"] { grid-row: 2; grid-column: 3; }
.keypad-button[data-key="."]{ grid-row: 2; grid-column: 4;}
.keypad-button[data-key="1"] { grid-row: 3; grid-column: 1; }
.keypad-button[data-key="2"] { grid-row: 3; grid-column: 2; }
.keypad-button[data-key="3"] { grid-row: 3; grid-column: 3; }
.keypad-button[data-key="0"] { grid-row: 4; grid-column: 1 / span 3; }

/* -------------------- 전체화면 (시인성 개선) -------------------- */
.fullscreen{
    display:none; position:fixed; inset:0; background:#1a1a2e; z-index:9999;
    flex-direction:column; align-items:center; justify-content:flex-start;
    padding-top:20px; overflow-y:hidden;
}
.fs-title{font-size:30px; margin-bottom:15px; color:#3498db; font-weight:700;}
.fs-info-container {
    display: flex; justify-content: space-between; width: 90%; max-width: 800px;
    margin-bottom: 20px; background: #252540; padding: 15px; border-radius: 14px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
.fs-info-left, .fs-info-right {flex: 1; min-width: 0; text-align: center;}
.fs-info-title {font-size: 18px; color: #f0f0f0; font-weight: 700; margin-bottom: 8px;}
.fs-info-text {font-size: 16px; color: #ccc; line-height: 1.5; white-space: pre-wrap;}
.fs-summary {font-size: 18px; color: #e74c3c; margin-bottom: 8px; font-weight: 900;}
.fs-sub {
    font-size: 14px; color: #ccc; white-space: pre-wrap; text-align: center;
    max-height: 100px; overflow-y: auto; padding: 0 10px; box-sizing: border-box;
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px 15px;
}
.cuts-title-row {
    display: flex; justify-content: space-between; width: 95%; max-width: 800px;
    padding: 10px 15px; margin-top: 15px; border-bottom: 2px solid #3498db;
    font-weight: 900; font-size: 20px; color: #3498db; text-align: center;
}
.cuts-title-row .cuts-title-left {text-align: left; flex: 1;}
.cuts-title-row .cuts-title-right {text-align: right; min-width: 100px; padding-right: 15px;}
.cuts-fs{
    max-height: calc(100vh - 270px); overflow-y:auto; width:95%; max-width:800px;
    margin-bottom:10px; padding-right: 15px;
}
.controls-bottom{position:fixed; bottom:10px; display:flex; gap:12px;}
.controls-bottom button{padding:12px 20px; font-size:18px; border-radius:12px; border:none; background:#e74c3c; color:#fff; font-weight:700;}
.controls-bottom button:active{background:#c0392b;}

#fsCuts .cut-row{
    margin-bottom: 6px; padding: 15px 20px; border-radius: 12px; background: #2f2f50;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3); align-items: center; display: flex;
    transition: background-color 0.2s;
}
#fsCuts .cut-left {flex: 1; display: flex; flex-direction: column; align-items: flex-start;}
#fsCuts .prod-name-row {display: flex; align-items: baseline; gap: 10px;}
#fsCuts .prod-name{font-size:30px; font-weight:900; color:#3498db;}
#fsCuts .main-len{font-size:32px; font-weight:900; color: #f0f0f0;}
#fsCuts .required-len{font-size:16px; color:#b0b0d0; font-weight:500; margin-top: 4px;}
#fsCuts .cut-pos{font-size:68px; font-weight:900; color:#e74c3c;}

/* -------------------- 모달 -------------------- */
.custom-modal-overlay{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:10001; justify-content:center; align-items:center; padding:20px;}
.custom-modal-content{background:#252540; padding:25px; border-radius:15px; width:90%; max-width:400px; box-shadow:0 0 20px rgba(0,0,0,0.5); text-align:center;}
.modal-title{font-size:22px; font-weight:700; color:#3498db; margin-bottom:15px;}
.modal-message{font-size:16px; color:#ccc; margin-bottom:20px; white-space:pre-wrap;}
.modal-buttons button{padding:10px 20px; font-size:16px; border-radius:8px; border:none; font-weight:700; transition:background 0.2s; cursor:pointer;}
#passwordModalInput{
    width:100%; padding:10px; font-size:20px; border-radius:8px;
    border:1px solid #3e3e60; margin-top:10px; background:#333355;
    color:#fff; box-sizing:border-box; text-align:center;
}
#modalConfirmBtn{background:#3a79d8; color:#fff; margin-left:10px;}
#modalConfirmBtn:active{background:#2a69c8;}
#modalCancelBtn{background:#555; color:#fff;}
#modalCancelBtn:active{background:#444;}
#passwordModalOverlay .modal-buttons button {width: 48%;}
#pwdConfirmBtn {background: #e74c3c !important;}
#pwdConfirmBtn:active {background: #c0392b !important;}

</style>
</head>
<body onload="loadResults()">
<h1>넘기기 작업 계산기</h1>
<div class="content-wrapper">
    <div class="top-area">
        <div class="info-panel">
            <label>총 원단 길이 (m)</label>
            <input type="text" readonly id="totalInput" placeholder="예: 501.54">
            <label>여유율 (%)</label>
            <input type="text" readonly id="marginInput" placeholder="예: 2" value="2">
            <div class="buttons">
                <button id="calcBtn" type="button" class="btn-primary">계산하기</button>
                <button id="resetBtn" type="button">초기화</button>
                <button id="fsBtn" type="button">작업표</button>
            </div>
        </div>
        <div class="prod-panel">
            <label>제품 길이 (m)</label>
            <div class="prod-list" id="prodList"></div>
            <div class="buttons">
                <button id="addProd" type="button">+ 1개 추가</button>
                <button id="addMultiProd" type="button" class="btn-primary">+ 여러 개 추가</button>
                <button id="removeProd" type="button">- 제품 제거</button>
            </div>
        </div>
        <div class="record-panel">
            <label>저장된 계산 기록</label>
            <div class="record-list" id="recordList">
                <div style="padding:15px; text-align:center; color:#ccc;">저장된 기록이 없습니다.</div>
            </div>
        </div>
    </div>
    <div class="cuts" id="previewCuts">
        <h3>계산 결과 미리보기 (재단 위치)</h3>
        <div class="preview-cuts-list" id="previewCutsList">
            <div style="padding:15px; text-align:center; color:#ccc;">계산된 재단 목록이 없습니다.</div>
        </div>
    </div>
</div>

<div id="softKeypad" style="display: none;">
    <button class="keypad-button" data-key="7">7</button>
    <button class="keypad-button" data-key="8">8</button>
    <button class="keypad-button" data-key="9">9</button>
    <button class="keypad-button keypad-action del-key" data-key="back">⌫</button>
    <button class="keypad-button" data-key="4">4</button>
    <button class="keypad-button" data-key="5">5</button>
    <button class="keypad-button" data-key="6">6</button>
    <button class="keypad-button keypad-action" data-key="enter" id="enterKey">확인</button>
    <button class="keypad-button" data-key="1">1</button>
    <button class="keypad-button" data-key="2">2</button>
    <button class="keypad-button" data-key="3">3</button>
    <button class="keypad-button" data-key="." id="dotKey">.</button>
    <button class="keypad-button" data-key="0" id="zeroKey">0</button>
</div>

<div id="fsContainer" class="fullscreen">
  <div class="fs-title">재단 위치 표시</div>
    <div class="fs-info-container">
        <div class="fs-info-left">
            <div class="fs-info-title">원단 정보</div>
            <div class="fs-info-text" id="fsInfo"></div>
        </div>
        <div class="fs-info-right">
            <div class="fs-summary" id="fsSummary"></div>
            <div class="fs-sub" id="fsSub"></div>
        </div>
    </div>
    <div class="cuts-title-row">
        <div class="cuts-title-left">제품 정보</div>
        <div class="cuts-title-right">재단 위치</div>
    </div>
  <div class="cuts cuts-fs" id="fsCuts"></div>
  <div class="controls-bottom">
    <button id="exitBtn" type="button">종료</button>
  </div>
</div>
<div id="customModalOverlay" class="custom-modal-overlay">
    <div class="custom-modal-content">
        <div id="modalTitle" class="modal-title"></div>
        <div id="modalMessage" class="modal-message"></div>
        <div class="modal-buttons">
            <button id="modalCancelBtn" type="button">취소</button>
            <button id="modalConfirmBtn" type="button">확인</button>
        </div>
    </div>
</div>
<div id="passwordModalOverlay" class="custom-modal-overlay">
    <div class="custom-modal-content">
        <div class="modal-title">기록 삭제 보안 확인</div>
        <div class="modal-message">기록을 삭제하려면 비밀번호를 입력해주세요.</div>
        <input type="password" readonly id="passwordModalInput" placeholder="비밀번호 입력" inputmode="numeric">
        <div class="modal-buttons" style="margin-top:20px;">
            <button id="pwdCancelBtn" type="button">취소</button>
            <button id="pwdConfirmBtn" type="button">삭제 확인</button>
        </div>
    </div>
</div>

<div id="multiAddModalOverlay" class="custom-modal-overlay">
    <div class="custom-modal-content">
        <div class="modal-title">제품 반복 추가</div>
        <div class="modal-message">추가할 제품의 길이와 수량을 입력하세요.</div>
        
        <label>제품 길이 (m)</label>
        <input type="text" readonly id="multiProdLengthInput" placeholder="예: 100">
        
        <label style="margin-top:15px;">수량</label>
        <input type="text" readonly id="multiProdQtyInput" placeholder="예: 5">

        <div class="modal-buttons" style="margin-top:20px;">
            <button id="multiCancelBtn" type="button">취소</button>
            <button id="multiConfirmBtn" type="button" class="btn-primary" style="background-color: #2ecc71;">추가하기</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
const MAX_PROD = 20;
const STORAGE_KEY = 'cutCalculatorRecords';
const DELETE_PASSWORD = '1205';

const prodList = document.getElementById('prodList');
const recordList = document.getElementById('recordList');
const totalInput = document.getElementById('totalInput');
const marginInput = document.getElementById('marginInput');
const addBtn = document.getElementById('addProd');
const removeBtn = document.getElementById('removeProd');
const calcBtn = document.getElementById('calcBtn');
const resetBtn = document.getElementById('resetBtn');
const previewCutsList = document.getElementById('previewCutsList');
const fsBtn = document.getElementById('fsBtn');
const fsContainer = document.getElementById('fsContainer');
const exitBtn = document.getElementById('exitBtn');
const softKeypad = document.getElementById('softKeypad');
const fsSummary = document.getElementById('fsSummary');
const fsInfo = document.getElementById('fsInfo');
const fsSub = document.getElementById('fsSub');
const dotKey = document.getElementById('dotKey');

const customModalOverlay = document.getElementById('customModalOverlay');
const modalTitle = document.getElementById('modalTitle');
const modalMessage = document.getElementById('modalMessage');
const modalConfirmBtn = document.getElementById('modalConfirmBtn');
const modalCancelBtn = document.getElementById('modalCancelBtn');

const passwordModalOverlay = document.getElementById('passwordModalOverlay');
const passwordModalInput = document.getElementById('passwordModalInput');
const pwdConfirmBtn = document.getElementById('pwdConfirmBtn');
const pwdCancelBtn = document.getElementById('pwdCancelBtn');

const addMultiBtn = document.getElementById('addMultiProd');
const multiAddModal = document.getElementById('multiAddModalOverlay');
const multiLengthInput = document.getElementById('multiProdLengthInput');
const multiQtyInput = document.getElementById('multiProdQtyInput');
const multiConfirmBtn = document.getElementById('multiConfirmBtn');
const multiCancelBtn = document.getElementById('multiCancelBtn');


let cutPlan = [];
let focusedInput = null;
let modalCallback = null;
let currentDeleteId = null;
let currentCutIndex = 0;

// ==========================================
// 기록 저장 및 불러오기 로직
// ==========================================
function getRecords(){
    try {
        const json = localStorage.getItem(STORAGE_KEY);
        return json ? JSON.parse(json) : [];
    } catch (e) {
        console.error("Error reading localStorage:", e);
        return [];
    }
}

function saveRecords(records){
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    } catch (e) {
        console.error("Error writing localStorage:", e);
        showModal('저장 오류', '계산 기록을 기기에 저장하는 데 실패했습니다.', false);
    }
}

function saveResult(){
    const currentRecords = getRecords();
    const prodInputs = [];
    prodList.querySelectorAll('input').forEach(input => {
        if(parseFloat(input.value)>0) prodInputs.push(input.value);
    });

    if (prodInputs.length === 0) return;

    const newRecord = {
        id: Date.now(),
        timestamp: new Date().toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }),
        totalInput: totalInput.value,
        marginInput: marginInput.value,
        prodInputs: prodInputs,
        cutPlan: cutPlan
    };

    currentRecords.unshift(newRecord);
    saveRecords(currentRecords);
    renderRecords(currentRecords);
}

function restoreRecord(record){
    prodList.innerHTML = '';
    totalInput.value = record.totalInput;
    marginInput.value = record.marginInput;
    record.prodInputs.forEach(val => createProdInput(Math.floor(parseFloat(val))));
    let currentProdCount = prodList.querySelectorAll('.prod-row').length;
    while(currentProdCount < 6){
        createProdInput('');
        currentProdCount++;
    }
    cutPlan = record.cutPlan;
    renderPreview();
    showModal('기록 불러오기','선택한 기록으로 계산기 입력값이 복원되었습니다. 재계산 또는 전체화면을 확인하세요.',false);
}

function deleteRecord(id){
    currentDeleteId = id;
    showPasswordModal();
}

function processDelete(){
    const idToDelete = currentDeleteId;
    let currentRecords = getRecords();
    currentRecords = currentRecords.filter(record => record.id !== idToDelete);
    saveRecords(currentRecords);
    renderRecords(currentRecords);
    showModal('삭제 완료', '선택한 계산 기록이 삭제되었습니다.', false);
    currentDeleteId = null;
}

function renderRecords(records){
    recordList.innerHTML = '';
    if(records.length === 0){
        recordList.innerHTML = '<div style="padding:15px; text-align:center; color:#ccc;">저장된 기록이 없습니다.</div>';
        return;
    }

    records.forEach(record => {
        const item = document.createElement('div');
        item.className = 'record-item';
        item.setAttribute('data-id', record.id);
        
        item.addEventListener('click', (e) => {
            if(e.target.className.includes('record-delete') || e.target.tagName === 'BUTTON') return;
            restoreRecord(record);
        });

        const numProds = record.prodInputs.length;
        const totalLen = Math.floor(parseFloat(record.totalInput));

        item.innerHTML = `
            <div class="record-details">
                <div class="record-date">${record.timestamp}</div>
                <div class="record-summary">총 ${totalLen}m / 제품 ${numProds}개</div>
            </div>
            <button class="record-delete" type="button" data-id="${record.id}">❌</button>
        `;

        item.querySelector('.record-delete').addEventListener('click', (e) => {
            e.stopPropagation();
            deleteRecord(record.id);
        });

        recordList.appendChild(item);
    });
}

window.loadResults = function() {
    renderRecords(getRecords());
}


// ==========================================
// 키패드 및 입력 로직
// ==========================================
function getAllInputs() {
    const allInputs = [totalInput, marginInput];
    prodList.querySelectorAll('input').forEach(input => allInputs.push(input));
    return allInputs;
}

function removeFocus(input) {
    if(input) input.style.border='1px solid #3e3e60';
}

function inputClickHandler(event){
    removeFocus(focusedInput);
    focusedInput = event.target;
    focusedInput.style.border='1px solid #3498db';
    softKeypad.style.display='grid';
    
    const isProdInput = focusedInput.closest('.prod-panel') !== null;
    const isPwdInput = focusedInput === passwordModalInput;

    if (isProdInput || isPwdInput || focusedInput === multiLengthInput || focusedInput === multiQtyInput) {
        dotKey.style.display = 'none';
    } else {
        dotKey.style.display = 'block';
    }

    if(focusedInput !== passwordModalInput && !focusedInput.closest('#multiAddModalOverlay')) {
        setTimeout(()=>{
            const keypadHeight = softKeypad.offsetHeight;
            const inputRect = focusedInput.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const contentWrapper = document.querySelector('.content-wrapper');
            const currentScroll = contentWrapper.scrollTop;
            const keypadTopOnViewport = viewportHeight - keypadHeight - 20;
            const inputBottomOnViewport = inputRect.bottom;
            
            if (inputBottomOnViewport > keypadTopOnViewport) {
                const scrollOffset = inputBottomOnViewport - keypadTopOnViewport + 10;
                contentWrapper.scrollTo({ top: currentScroll + scrollOffset, behavior: 'smooth' });
            } else if (inputRect.top < 0) {
                 contentWrapper.scrollTo({ top: currentScroll + inputRect.top - 10, behavior: 'smooth' });
            }
        }, 100);
    }
}

function createProdInput(value){
    const count = prodList.querySelectorAll('.prod-row').length + 1;
    if(count>MAX_PROD) return;
    
    const label = `제품 ${count}`;

    const row=document.createElement('div');
    row.className='prod-row';
    const displayValue = value!==undefined && !isNaN(parseFloat(value)) ? Math.floor(parseFloat(value)) : '';
    row.innerHTML=`<div>${label}</div><input type="text" readonly placeholder="길이 (m)" value="${displayValue}">`;
    const input=row.querySelector('input');
    input.addEventListener('click', inputClickHandler);
    prodList.appendChild(row);

    setTimeout(() => {
        if (prodList.scrollHeight > prodList.clientHeight) {
            prodList.scrollTop = prodList.scrollHeight;
        }
    }, 100);
}

function initializeProdInputs(){
    removeFocus(focusedInput);
    focusedInput=null;
    softKeypad.style.display='none';
    prodList.innerHTML='';
    cutPlan=[];
    for(let i=0;i<6;i++) createProdInput('');
}

totalInput.addEventListener('click', inputClickHandler);
marginInput.addEventListener('click', inputClickHandler);
passwordModalInput.addEventListener('click', inputClickHandler);
multiLengthInput.addEventListener('click', inputClickHandler);
multiQtyInput.addEventListener('click', inputClickHandler);
initializeProdInputs();

softKeypad.addEventListener('click',(event)=>{
    const key=event.target.dataset.key;
    if(!key||!focusedInput) return;
    
    let val=focusedInput.value;
    
    if(key==='enter'){
        if(focusedInput === passwordModalInput) {
             pwdConfirmBtn.click();
             return;
        }
        if (focusedInput === multiLengthInput) { // 길이 입력 후 수량으로 자동 포커스 이동
            multiQtyInput.click();
            return;
        }
        if (focusedInput === multiQtyInput) { // 수량 입력 후 추가하기 버튼 클릭
            multiConfirmBtn.click();
            return;
        }

        const allInputs = getAllInputs();
        const idx = allInputs.indexOf(focusedInput);
        removeFocus(focusedInput); focusedInput=null;
        if(idx!==-1 && idx<allInputs.length-1) inputClickHandler({target:allInputs[idx+1]});
        else softKeypad.style.display='none';
        return;
    }

    if(key==='back'){
        focusedInput.value=val.slice(0,-1);
    }
    else if(key==='.'){
        if(dotKey.style.display === 'none') return;
        if(!val.includes('.')) focusedInput.value=val+'.';
    }
    else if(key>='0'&&key<='9'){
        if (focusedInput === totalInput || focusedInput === marginInput) {
            if(val.includes('.')){ const dec=val.split('.')[1]; if(dec && dec.length>=2) return; }
            focusedInput.value=val+key;
        } else {
             focusedInput.value=val+key;
        }
    }
});

document.addEventListener('click',(event)=>{
    const isInput = event.target.tagName === 'INPUT';
    const isInKeypad = event.target.closest('#softKeypad');
    const isInModal = event.target.closest('.custom-modal-overlay');
    const isInRecordItem = event.target.closest('.record-item');

    if (isInModal || isInRecordItem) return;

    if(!isInput && !isInKeypad && softKeypad.style.display === 'grid'){
        softKeypad.style.display='none';
        removeFocus(focusedInput); focusedInput=null;
    }
});


// ==========================================
// 버튼 및 계산 로직
// ==========================================
addBtn.addEventListener('click',()=>{createProdInput('');});
removeBtn.addEventListener('click',()=>{
    const rows=prodList.querySelectorAll('.prod-row');
    if(rows.length===1){ showModal('경고',"최소한 1개의 제품은 유지해야 합니다.",false); return; }
    const lastInput=rows[rows.length-1].querySelector('input');
    if(focusedInput===lastInput){ removeFocus(focusedInput); focusedInput=null; softKeypad.style.display='none'; }
    prodList.removeChild(rows[rows.length-1]);
});

resetBtn.addEventListener('click',(e)=>{
    e.preventDefault();
    showModal('초기화 확인','모든 입력값과 계산 결과를 초기화하시겠습니까?\n(기록은 삭제되지 않습니다.)',true,(confirmed)=>{
        if(confirmed){
            totalInput.value='';
            marginInput.value='2';
            initializeProdInputs();
            previewCutsList.innerHTML='<div style="padding:15px; text-align:center; color:#ccc;">계산된 재단 목록이 없습니다.</div>';
            fsContainer.style.display='none';
        }
    });
});

function buildCutPlan(){
    softKeypad.style.display='none'; removeFocus(focusedInput); focusedInput=null;
    const total_m=parseFloat(totalInput.value);
    const total_mm=Math.round(total_m*1000);
    
    if(isNaN(total_m)||total_m<=0){ showModal('경고','총 원단 길이(m)를 0보다 크게 입력해 주세요.',false); return false; }

    const margin_perc = parseFloat(marginInput.value) || 0;
    const lens_mm=[];
    prodList.querySelectorAll('input').forEach((i)=>{
        const v_m=parseInt(i.value);
        if(!isNaN(v_m)&&v_m>0){
            const len_mm = Math.round(v_m * 1000);
            let required_mm;
            
            if (v_m < 50) {
                required_mm = len_mm + 1000;
            } else if (v_m >= 50 && v_m < 100) {
                required_mm = len_mm + 2000;
            } else {
                required_mm = Math.ceil(len_mm * (1 + margin_perc / 100));
            }
            
            lens_mm.push({len_mm, required_mm});
        }
    });

    if(lens_mm.length===0){ showModal('경고','유효한 제품 길이를 1개 이상 입력해 주세요.',false); return false; }

    cutPlan=[];
    let cumulative=0;
    for(let i=0;i<lens_mm.length;i++){
        const item_mm = lens_mm[i];
        const required_mm = item_mm.required_mm;
        cumulative+=required_mm;
        if(cumulative>total_mm){
            showModal('작업 중단 경고',`⛔ 작업 중단: 총 원단 길이를 초과했습니다!\n제품 ${i+1} (${(item_mm.len_mm/1000).toFixed(0)}m) 재단 시 총 원단 길이 (${total_m.toFixed(2)}m) 초과.`,false);
            break;
        }
        const remaining_mm=total_mm-cumulative;
        cutPlan.push({
            index:i+1,
            prodLen_m: (item_mm.len_mm/1000).toFixed(2),
            required_m:(required_mm/1000).toFixed(2),
            cutPos:Math.floor(remaining_mm/1000)
        });
    }
    renderPreview();
    return true;
}

function renderPreview(){
    previewCutsList.innerHTML='';
    if(cutPlan.length===0){previewCutsList.innerHTML+='<div style="padding:15px;text-align:center;color:#ccc;">계산된 재단 목록이 없습니다.</div>'; return;}
    cutPlan.forEach(item=>{
        const row=document.createElement('div'); row.className='cut-row';
        row.innerHTML=`<div class="cut-left"><div class="prod-name">제품 ${item.index}</div><div class="prod-len">${item.prodLen_m} m (필요 길이:${item.required_m} m)</div></div><div class="cut-pos">${item.cutPos} m</div>`;
        previewCutsList.appendChild(row);
    });
}

// ==========================================
// 전체 화면 로직
// ==========================================

function showFullscreen(){
    if (cutPlan.length === 0) {
        showModal('알림', '먼저 계산을 수행하여 재단 목록을 만드세요.', false);
        return;
    }

    const lens = prodList.querySelectorAll('input');
    let subText = '';
    let validProductsCount = 0;
    
    lens.forEach((i, idx) => {
        const value = i.value.trim();
        if (value && parseInt(value) > 0) {
            const label = `제품 ${idx + 1}`;
            const displayValue = Math.floor(parseFloat(value));
            subText += `<div>${label}: ${displayValue} m</div>`; 
            validProductsCount++;
        }
    });

    fsSummary.innerText = `제품 수량: ${validProductsCount}개`;

    const total_m = totalInput.value ? parseFloat(totalInput.value).toFixed(2) : 'N/A';
    const margin_perc = marginInput.value ? parseFloat(marginInput.value).toFixed(0) : 'N/A';
    
    fsInfo.innerText = `총 원단 길이: ${total_m} m\n여유율: ${margin_perc}%`;
    
    fsSub.innerHTML = subText; 

    const fsCuts = document.getElementById('fsCuts');
    fsCuts.innerHTML = '';
    cutPlan.forEach(item => {
        const row = document.createElement('div'); row.className = 'cut-row';
        const label = `제품 ${item.index}`;
        const integerProdLen = Math.floor(parseFloat(item.prodLen_m));
        
        row.innerHTML = `<div class="cut-left">
                            <div class="prod-name-row">
                                <div class="prod-name">${label}</div>
                                <div class="main-len">${integerProdLen} m</div>
                            </div>
                            <div class="required-len">(필요 길이: ${item.required_m} m)</div>
                        </div>
                        <div class="cut-pos-panel">
                            <div class="cut-pos">${item.cutPos} m</div>
                        </div>`;
        fsCuts.appendChild(row);
    });
    
    fsContainer.style.display = 'flex';
    currentCutIndex = 0;
    renderFullscreenCut(0);
}

calcBtn.addEventListener('click', () => {
    if (buildCutPlan()) {
        if (cutPlan.length > 0) {
            saveResult();
            showFullscreen();
        }
    }
});

fsBtn.addEventListener('click', showFullscreen);

exitBtn.addEventListener('click',()=>{fsContainer.style.display='none';});

// ==========================================
// 모달 및 비밀번호 로직
// ==========================================
function showModal(title,message,confirm=false,callback){
    passwordModalOverlay.style.display='none';
    softKeypad.style.display = 'none';

    modalTitle.innerText=title;
    modalMessage.innerText=message;
    modalConfirmBtn.style.display=confirm?'inline-block':'none';
    
    if (!confirm) {
        modalCancelBtn.innerText = '확인';
        modalCancelBtn.style.marginLeft = '0';
        modalCancelBtn.style.backgroundColor = '#3498db';
    } else {
        modalCancelBtn.innerText = '취소';
        modalCancelBtn.style.marginLeft = '10px';
        modalCancelBtn.style.backgroundColor = '#555';
    }

    customModalOverlay.style.display='flex';
    modalCallback=callback||null;
}

modalCancelBtn.addEventListener('click',()=>{
    customModalOverlay.style.display='none';
    if(modalCallback) modalCallback(false);
});
modalConfirmBtn.addEventListener('click',()=>{
    customModalOverlay.style.display='none';
    if(modalCallback) modalCallback(true);
});

function showPasswordModal(){
    customModalOverlay.style.display='none';
    
    passwordModalInput.value = '';
    passwordModalOverlay.style.display = 'flex';
    setTimeout(() => {
        passwordModalInput.click();
    }, 50);
}

pwdCancelBtn.addEventListener('click', () => {
    passwordModalOverlay.style.display = 'none';
    softKeypad.style.display = 'none';
    removeFocus(focusedInput);
    focusedInput = null;
    currentDeleteId = null;
});

pwdConfirmBtn.addEventListener('click', () => {
    softKeypad.style.display = 'none';
    removeFocus(focusedInput);
    focusedInput = null;

    const inputPwd = passwordModalInput.value;
    if (inputPwd === DELETE_PASSWORD) {
        passwordModalOverlay.style.display = 'none';
        processDelete();
    } else {
        passwordModalOverlay.style.display = 'none';
        showModal('경고', '비밀번호가 일치하지 않습니다. 다시 시도해주세요.', false, () => {
            showPasswordModal();
        });
    }
});

// 키보드 방향키로 풀스크린 재단 목록 넘기기
document.addEventListener('keydown', (e) => {
    if (fsContainer.style.display === 'flex' && cutPlan.length > 0) {
        e.preventDefault();
        if (e.key === 'ArrowRight' || e.key === ' ' || e.key === 'ArrowDown') { 
            currentCutIndex = (currentCutIndex + 1) % cutPlan.length;
            renderFullscreenCut(currentCutIndex);
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') { 
            currentCutIndex = (currentCutIndex - 1 + cutPlan.length) % cutPlan.length;
            renderFullscreenCut(currentCutIndex);
        } else if (e.key === 'Escape') {
             fsContainer.style.display='none';
        }
    }
});

function renderFullscreenCut(index) {
    const allRows = document.querySelectorAll('#fsCuts .cut-row');
    allRows.forEach((row, idx) => {
        if (idx === index) {
            row.style.backgroundColor = '#4a4a75'; // 강조 색상
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            row.style.backgroundColor = '#2f2f50'; // 기본 색상
        }
    });
}

// "여러 개 추가" 기능
addMultiBtn.addEventListener('click', () => {
    multiLengthInput.value = '';
    multiQtyInput.value = '';
    multiAddModal.style.display = 'flex';
    setTimeout(() => {
        multiLengthInput.click();
    }, 50);
});

multiCancelBtn.addEventListener('click', () => {
    multiAddModal.style.display = 'none';
    softKeypad.style.display = 'none';
    removeFocus(focusedInput);
    focusedInput = null;
});

multiConfirmBtn.addEventListener('click', () => {
    const length = parseInt(multiLengthInput.value);
    let quantity = parseInt(multiQtyInput.value);

    if (isNaN(length) || length <= 0) {
        showModal('입력 오류', '올바른 제품 길이를 입력하세요.', false);
        return;
    }
    if (isNaN(quantity) || quantity <= 0) {
        showModal('입력 오류', '올바른 수량을 입력하세요.', false);
        return;
    }

    const allProdInputs = prodList.querySelectorAll('input');

    for (const input of allProdInputs) {
        if (quantity === 0) break;
        if (input.value.trim() === '') {
            input.value = length;
            quantity--;
        }
    }

    for (let i = 0; i < quantity; i++) {
        createProdInput(length);
    }
    
    multiAddModal.style.display = 'none';
    softKeypad.style.display = 'none';
    removeFocus(focusedInput);
    focusedInput = null;
});


});
</script>
</body>
</html>
